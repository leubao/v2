<Managetemplate file="Wechat/Public/header"/>
<script type="text/javascript">
    var global = {$goods_info};
</script>
<div class="page">
  <header class="bar bar-nav">
    <h1 class="title"><i class="iconfont">&#xe603</i>{$wechat.page_title}</h1>
    <if condition="empty($uinfo['promote'])">
    <button class="button button-link button-nav pull-right"  ontouchend="window.location.href='{:U('Wechat/Index/uinfo');}'">
    </if>
      <span class="icon icon-me"></span>
    </button>
  </header>
  <nav class="bar bar-tab bar-height">
      <div class="btn"><a href="#" class="button button-big button-fill button-warning open-goods-cart">立即预定</a></div>
  </nav>
  <div class="swiper-container">
    <div class="swiper-wrapper">
        <div class="swiper-slide"><img src="d/wap/1.jpg"></div>
        <div class="swiper-slide"><img src="d/wap/2.jpg"></div>
        <div class="swiper-slide"><img src="d/wap/3.jpg"></div>
        <div class="swiper-slide"><img src="d/wap/4.jpg"></div>
        <div class="swiper-slide"><img src="d/wap/5.jpg"></div>
        <div class="swiper-slide"><img src="d/wap/6.jpg"></div>
        <div class="swiper-slide"><img src="d/wap/7.jpg"></div>
        <div class="swiper-slide"><img src="d/wap/8.jpg"></div>
    </div>
    <!-- Add Pagination -->
    <div class="swiper-pagination"></div>
  </div>
  <!--内容-->
</div>

<!-- About Popup -->
<div class="popup goods-cart">
  <header class="bar bar-nav">
    <a href="#" class="icon pull-right close-popup"><i class="iconfont">&#xe609</i></a>
  </header>
  <div class="sku-layout">
    <div class="adv-opts layout-content">
    <div class="goods-models js-sku-views block block-list block-border-top-none">
      <dl class="clearfix block-item">
        <dt class="model-title sku-sel-title">
          <label>演出时间：</label>
        </dt>
        <dd>
          <ul class="model-list sku-sel-list" id="plan">
          </ul>
        </dd>
      </dl>
      <dl class="clearfix block-item">
        <dt class="model-title sku-sel-title">
          <label>演出票价：</label>
        </dt>
        <dd>
          <ul class="model-list sku-sel-list" id="price">
            <li class="tag sku-tag pull-left ellipsis unavailable">请选择售票日期</li>
          </ul>
        </dd>
      </dl>
      <dl class="clearfix block-item">
        <dt class="model-title sku-num pull-left">
          <label>数量</label>
        </dt>
        <dd>
          <dl class="clearfix">
            <div class="quantity">
              <button class="minus disabled" type="button" disabled="true"></button>
              <input type="text" class="txt" value="1" id="num">
              <button class="plus" type="button"></button>
              <div class="response-area response-area-minus"></div>
              <div class="response-area response-area-plus"></div>
              <div class="txtCover"></div>
            </div>
            <div class="stock pull-right font-size-12">
              <dt class="model-title stock-label pull-left">
                <label>剩余: </label>
              </dt>
              <dd class="stock-num"> 0 </dd>
            </div>
          </dl>
        </dd>
      </dl>
      <div class="block-item block-item-messages">
        <div class="sku-message">
          <dl class="clearfix">
            <dt class="pull-left">
              <label for="ipt-0"><sup class="required">*</sup>姓名</label>
            </dt>
            <dd class="comment-wrapper clearfix">
              <input data-valid-type="text" required="" tabindex="1" id="name" name="name" type="text" class="txt js-message font-size-14">
            </dd>
          </dl>
          <dl class="clearfix">
            <dt class="pull-left">
              <label for="ipt-1"><sup class="required">*</sup>电话</label>
            </dt>
            <dd class="comment-wrapper clearfix">
              <input data-valid-type="text" required="" tabindex="2" id="phone" name="phone" type="text" class="txt js-message font-size-14">
            </dd>
          </dl>
          <dl class="clearfix">
            <dt class="pull-left">
              <label for="ipt-2">身份证</label>
            </dt>
            <dd class="comment-wrapper clearfix">
              <input data-valid-type="text" tabindex="3" id="card" name="card" type="text" class="txt js-message font-size-14">
            </dd>
          </dl>
          <dl class="clearfix">
            <dt class="pull-left">
              <label for="ipt-2">留言</label>
            </dt>
            <dd class="comment-wrapper clearfix item-input">
             <input data-valid-type="text" tabindex="3" id="remark" name="remark" type="text" class="txt js-message font-size-14" value="">
            </dd>
          </dl>
        </div>
      </div>
    </div>
    <div class="btn">
      <a href="#" class="button button-fill button-warning button-big buy">下一步</a>
    </div>
  </div>
  </div>
</div>
<!--产品信息区域-->
<Managetemplate file="Wechat/Public/footer"/>
<script type="text/javascript">
  $(function() {
    wx.ready(function(){
        wx.checkJsApi({
            jsApiList: [
                'onMenuShareAppMessage',
            ]
        });
        wx.showMenuItems({
            menuList: ['menuItem:share:appMessage','menuItem:share:timeline']
        });
        wx.onMenuShareAppMessage({
            title: '{$wechat.share_title}',
            desc: '{$wechat.share_desc}',
            link: '{$urls}',
            imgUrl: '{$config_siteurl}static/images/wshare_{$pid}.jpg',
            trigger: function (res) {
            },
            success: function (res) {
                alert('分享给好友成功');
            },
            cancel: function (res) {
            },
            fail: function (res) {
                alert(JSON.stringify(res));
            }
        });
        wx.onMenuShareTimeline({
            title: '{$wechat.share_title}',
            desc: '{$wechat.share_desc}',
            link: '{$urls}',
            imgUrl: '{$config_siteurl}static/images/wshare_{$pid}.jpg',
            trigger: function (res) {
            },
            success: function (res) {
              /*
                $.post('../api/v0.0.1/marketing.php', {
                        action:'ShareLog',
                        openid:'',
                        page_id: ''
                    }, function (json) {
                    alert('分享成功');

                }, 'json');*/
            },
            cancel: function (res) {
            },
            fail: function (res) {
                alert(JSON.stringify(res));
            }
        });
    });
    $(".swiper-container").swiper({
      pagination: '.swiper-pagination',
      direction: 'vertical',
      slidesPerView: 1,
      paginationClickable: true,
      spaceBetween: 30,
      mousewheelControl: true
    });
    
    var getPlantpl = document.getElementById('plantpl').innerHTML;
    var getPricetpl = document.getElementById('pricetpl').innerHTML;
    laytpl(getPlantpl).render(global, function(html){
        document.getElementById('plan').innerHTML = html;
    });
    
    var plan = '0',
        area = '0',
        ticket = '0',
        price = '0',
        discount = '0',
        num = '0',
        name = '',
        phone = '',
        card = '',
        msg = '',
        pay = '',
        crm = '',
        param = '',
        toJSONString = '',
        postData = '',
        subtotal = '0',
        remark = '';
    $("#plan li").click(function(){
      //检查当前被选择的元素是否已经有已选中的
      $(".goods-models li").each(function(){
        if($(this).hasClass("tag-orangef60 active")){ toggle($(this))};
      });
      //为当前选择加上
      active($(this));
      refreshNum();
      plan = $(this).data('plan');
      area = 0; 
      ticket = 0;
      price = 0;
      $(".stock-num").html($(this).data('num'));
      laytpl.fn = plan;
      laytpl(getPricetpl).render(global, function(html){
        document.getElementById('price').innerHTML = html;
      });
    });
    
    $(document).on("click","#price li",function(){
       //判断是否已经选择计划
      if(!$(this).hasClass("unavailable")){
        if(plan != 0){
          $("#price li").each(function(){
            if($(this).hasClass("tag-orangef60 active")){ toggle($(this))};
          });
          area = $(this).data('area');
          ticket = $(this).data('priceid');
          price = $(this).data('price');
          discount = $(this).data('discount');
          num = $(this).data('num');
          //更新可售数量  当为0时 禁用
          $(".stock-num").html(num);
          active($(this));
          refreshNum();
        }else{
          $.toast("请选择演出日期!");
        }
      } 
    });
    //删除选中状态
    function toggle(t){t.toggleClass("tag-orangef60");t.toggleClass("active");}
    //选中
    function active(t){t.addClass("tag-orangef60");t.addClass("active");}
    //删除选中
    function deActive(t){t.removeClass("tag-orangef60");t.removeClass("active");}
    //数量增加减少
    $(".response-area-minus").click(function(){
      if(num > 1){
        num = getNum() - 1;
        updateNum();
      }else{
        updateBtnStatus();
      }
    });
    $(".response-area-plus").click(function(){
      //判断是否选择日期和价格
      if(plan != 0 && area != 0 && price != 0){
        if(num < global['user']['maxnum']){
          //限制单笔订单最大数量
          num = getNum() + 1;
          updateNum();
        }else{
          $.toast("亲，您一次只能买这么多了!");
        }
      }else if(plan == 0 && area == 0){
        $.toast("请选择演出日期和演出票价!");
      }else if(area == 0){
        $.toast("请选择演出票价!");
      }else{
        $.toast("请选择演出日期和演出票价!");
      }
    });
    function changeNum(t){
      $("#num").val();
    }
    //更换场次时重置页面
    function refreshNum(){
      $("#num").val('1');
      getNum();
      updateBtnStatus();
    }
    //更新数量
    function updateNum(){
        $("#num").val(num);
        updateBtnStatus();
    }
    //更新数量增减状态
    function updateBtnStatus(){
      if(num > 1){
        $('.minus').removeClass("disabled");
        $('.minus').removeAttr("disabled");
      }else{
        $('.minus').addClass("disabled"),
        $('.minus').attr("disabled", "true")
      }
    }
    //获取数量
    function getNum(){
      num = parseInt($("#num").val());
      return num;
    }
    
    $(".buy").click(function(){
      //验证输入
      name = $("#name").val().replace(/ /g,''),
      phone = $("#phone").val(),
      card = $("#card").val().replace(/ /g,''),
      msg = '';
      if(plan.length == 0){
        msg = "请选择销售日期!";
      }
      if(price.length == 0 || num == 0){
        msg = "请选择票型并选择要购买的数量!";
      }
      if(name.length == 0){
        msg = "姓名不能为空";
      }
      if(!/^(0|86|17951)?(13[0-9]|15[012356789]|18[0-9]|14[57]|17[0-9])[0-9]{8}$/.test(phone)){
        msg = "手机号码格式不正确!";
      }
      if(msg != ''){$.toast(msg);return false;}
      if(card.length == 0){
        $.prompt('亲，您确定不用身份证取票这一高逼格的功能吗?', 
          function (value) {
            post_server(1,value);
          },
          function (value) {
            post_server(2);
          }
        );
      }else{
        if(/^(\d{15}$|^\d{18}$|^\d{17}(\d|X|x))$/.test(card) == false){
          msg = "身份证号码输入有误!";
        }else{
          post_server(2,card);
        }
      }
    });
    
    /*验证身份证取票 type  1验证 2 不验证  */
    function post_server(type,card){
      //计算金额
      if(global['user']['epay'] == '1'){
        subtotal = parseFloat(price * parseInt(num));
      }else{
        subtotal = parseFloat(discount * parseInt(num));
      }
      remark = $('#remark').val(); 
      $.ajax({
        type:'GET',
        url:'<?php echo U('Wechat/Index/quota');?>'+'&plan='+plan+'&cid='+global['user']['qditem']+'&num='+num,
        dataType:'json',
        timeout: 1500,
        error: function(){
          $.toast('服务器请求超时，请检查网络...');
        },
        success:function(data){
            if(data.statusCode == "200"){
              /*获取支付相关数据*/
              pay = '{"cash":0,"card":0,"alipay":0}';
              param = '{"remark":"'+remark+'","settlement":"'+global['user']['epay']+'"}';
              crm = '{"guide":"'+global['user']['guide']+'","qditem":"'+global['user']['qditem']+'","phone":"'+phone+'","contact":"'+name+'","memmber":"'+global['user']['memmber']+'"}';
              toJSONString = '{"areaId":'+area+',"priceid":'+ticket+',"price":'+price+',"num":'+num+'}';
              postData = 'info={"subtotal":"'+subtotal+'","plan_id":'+plan+',"checkin":1,"sub_type":0,"type":1,"data":['+ toJSONString + '],"crm":['+crm+'],"pay":['+pay+'],"param":['+param+']}';
              /*提交到服务器**/
              $.ajax({
                  type:'POST',
                  url:'<?php echo U('Wechat/Index/order',array('param'=>$param));?>',
                  data:postData,
                  dataType:'json',
                  success:function(data){
                      if(data.statusCode == "200"){
                          location.href = data.url;
                      }else{
                          $.toast("下单失败!");
                      }
                  }
              });
            }else{
              $.toast('配额不足，请联系渠道负责人');
            }
        }
      });
      
    }
  });
  $(document).on('click','.open-goods-cart', function () {
    $.popup('.goods-cart');
  });
</script>
<script id="plantpl" type="text/html">
{{# for(var i = 0, len = d.plan.length; i < len; i++){ }}
    <li class="tag sku-tag pull-left ellipsis" data-plan="{{ d.plan[i].id }}" data-num="{{d.plan[i].num}}">{{ d.plan[i].title }}</li>
{{# $(".stock-num").html(d.plan[i].num); } }}
</script>
<script id="pricetpl" type="text/html">
{{# $(d.area[laytpl.fn]).each(function(i){ }}
  <li class="tag sku-tag pull-left ellipsis {{# if(this.num == '0'){ }}unavailable{{# } }}" data-price="{{ this.money }}" data-discount="{{ this.moneys }}" data-area="{{ this.area }}" data-priceid="{{ this.priceid }}" data-num="{{ this.num }}">{{this.money}}元 ({{this.name}}{{this.remark}})</li>
{{#    });}}
</script>

</body>
</html>