<?php
// +----------------------------------------------------------------------
// | LubTMP 商户工作面板
// +----------------------------------------------------------------------
// | Copyright (c) 2014 http://www.leubao.com, All rights reserved.
// +----------------------------------------------------------------------
// | Author: zhoujing <admin@leubao.com>
// +----------------------------------------------------------------------
namespace Item\Controller;
use Libs\System\Cache;
use Common\Controller\ItemBase;
use Item\Service\Partner;
use Libs\Service\Operate;
use Libs\Service\Refund;
use Libs\Service\Sms;
class WorkController extends ItemBase{
	protected function _initialize() {
		parent::_initialize();
		//取得所有产品信息
		$this->products = cache('Product');
		//取得当前产品信息
		$this->product = $this->products[$this->pid];
	 }
	/*加载初始售票框架*/
	function index(){
		//获取所有销售计划
		if(IS_POST){
			$todaya = I('post.plan');
			if(empty($todaya)){
				$this->erun('请选择售票日期!');
			}
			$info = explode('-', $todaya);
		}else{
			//今天时间戳
			$today = strtotime(date('Y-m-d',time()));
			$todaya = $today."-1";
		}
		$map = array(
			'product_id'=>$this->pid,
			'status'=>2,//状态必为售票中
			'plantime' => (int)$info[0] ? (int)$info[0] : $today,
			'games' => (int)$info[1] ? (int)$info[1] : 1 ,
		);
		//取得今天计划的ID
		$todayplan = Operate::do_read('Plan',0,$map);
		session('plan',$todayplan);//缓存
		// 判断产品类型
		if($this->product['type'] <> '1'){
			$tictype = $this->getPrice('',$this->product['type'],'');
		}
		$plan = Operate::do_read('Plan',1,array('product_id'=>$this->pid,'status'=>2));
		$this->assign('plan',$plan)
		     ->assign('today',$todaya)
			 ->assign('todayplan',$todayplan) 
			 ->assign('area',unserialize($todayplan['param']))
			 ->assign('product',$this->product)
			 ->assign('tictype',$tictype)
		     ->display();
	}
	/**
	 * 根据区域加载座位信息   区域页面打开时  先加载座椅模板   然后加载售出情况   页面打开时  每个10分无刷新更新页面
	 * 
	 */
	function seat(){
		$aid = I('get.aid',0,intval);
		$plan = session('plan');
		if(empty($plan)){
			//强制刷新售票navtab
		}
		//获取计划信息
		/*$map = array(
			'id'=>$plan['id'],
			'status'=>2,
		);*/
		//获取当前选择区域的座椅
		$seat = Operate::do_read(ucwords($plan['seat_table']),1,array('area'=>$aid));
		$param = unserialize($plan['param']);
		//可售区域
		$this->assign('param',$param);
		//加载座椅
		$info = Operate::do_read('Area',0,array('id'=>$aid,'status'=>1));
		$seat = unserialize($info['seat']);
		$row = array_keys($seat);
		$this->assign('data',$info)
			 ->assign('seat',$seat)
			 ->assign('row',$row);
		//选中区域价格和座椅信息
		$tictype = $this->getPrice(1,$this->product['type'],$aid);
		$this->assign('tictype',$tictype);
		$this->assign('aid',$aid);
		$this->assign('plan',$plan);
		$this->assign('sid',$id);
		$this->display();
	}
	/**
	 * 加载座椅状态
	 */
	function seats(){
		$area = I('get.aid',0,intval);
		$plan_id = I('get.plan_id',0,intval);
		if(empty($area)){
			$this->erun('加载错误!');
		}
		if(!empty($plan_id)){
			$plan = Operate::do_read('Plan',0,array('id'=>$plan_id));
		}else{
			$plan = session('plan');
		}
		$table=ucwords($plan['seat_table']);
		//只查询已售出的座位
		$info = M($table)->where(array('area'=>$area,'status'=>array('NEQ',0)))->field(array('seat'=>'sid','status'))->select();
		$return = array(
			'status' => '1',
			'message' => '区域加载成功!',
			'seat'	=> $info ? $info : 0,
			);
		echo json_encode($return);
	}
	/**
	 * 门票销售
	 */
	function sales(){
		$aid = I('get.aid',0,intval);
		$this->available();//选中区域价格和座椅信息
		$this->getPrice(1,'',$aid);
		$this->display();
	}
	/**
	 * 散客售票
	 * */
	function single(){
		 $this->available();
		 $this->display();
	}
	/*团队售票*/
	function team(){
		if(IS_POST){
			$plan = I('post.plan');
			if(!empty($plan)){
				$this->srun('加载成功!','quick');
			}else{
				$this->erun('加载失败!');
			}
		}else {
			$this->available();
			$this->display();
		}
	}
	/*窗口门票预定*/
	function pre(){
		if(IS_POST){
			$plan = I('post.plan');
			if(!empty($plan)){
				$this->srun('加载成功!','quick');
			}else{
				$this->erun('加载失败!');
			}
		}else {
			$this->available();
			$this->display();
		}
	}
	/**
	 * 团队售票获取区域票型
	 */
	function teamPrice(){
		$aid = I('get.aid',0,intval);
		if(empty($aid)){
			$this->erun('未知区域!');
		}
		$tictype = $this->getPrice(2,$this->product['type'],$aid);
		$this->assign('tictype',$tictype)
			->assign('aid',$aid)
			->display();
	}
	//价格政策
	function prePrice(){
		$aid = I('get.aid',0,intval);
		if(empty($aid)){
			$this->erun('未知区域!');
		}
		$tictype = $this->getPrice(9,$this->product['type'],$aid);
		$this->assign('tictype',$tictype)
			->assign('aid',$aid)
			->display();
	}
	/**
	 * 快捷售票
	 */
	function quick(){
		if(IS_POST){
			$plan = I('post.plan');
			if(!empty($plan)){
				$this->srun('加载成功!','quick');
			}else{
				$this->erun('加载失败!');
			}
		}else {
			$this->available();
			$this->display();
		}
	}
	/**
	 * 快捷售票  获取区域票型
	 */
	function quickPrice(){
		$aid = I('get.aid',0,intval);
		if(empty($aid)){
			$this->erun('未知区域!');
		}
		$tictype = $this->getPrice('4','1',$aid);
		$this->assign('tictype',$tictype)
			->assign('aid',$aid)
			->display();
	}
	/**
	 * 订单出票
	 */
	function orderTicket(){
		$db = M('Order');
		if(IS_POST){
			if(I('get.type') == '1'){
				//根据订单号
				$sn = I('post.sn');
				$map = array(
					'product_id'=>\Libs\Util\Encrypt::authcode($_SESSION['lub_proId'], 'DECODE'),
					'order_sn' => array('like','%'.$sn.'%'),
				);
			}elseif(I('get.type') == '2'){
				//取票人手机
				$map = array(
					'product_id'=>\Libs\Util\Encrypt::authcode($_SESSION['lub_proId'], 'DECODE'),
					'phone' =>I('post.phone'),
					//'createtime'=>array('GT', strtotime(date("Ymd",time()))),//过滤已过期的订单
				);
			}else{
				//	获取销售计划
				$plan_time = strtotime(date('Y-m-d',time()));
				$plan = Operate::do_read('Plan',1,array('plantime'=>$plan_time),'',array('id'));
				$map = array(
					'product_id'=>	\Libs\Util\Encrypt::authcode($_SESSION['lub_proId'], 'DECODE'),
					'status'	=>	'1',
					'plan_id'	=>	array('in',implode(',',array_column($plan, 'id'))),
				);
			}
		}else{
			//默认加载当天未出票订单
			/**
			*	获取销售计划
			*/
			$plan_time = strtotime(date('Y-m-d',time()));
			$plan = Operate::do_read('Plan',1,array('plantime'=>$plan_time),'',array('id'));
			$map = array(
					'product_id'=>	\Libs\Util\Encrypt::authcode($_SESSION['lub_proId'], 'DECODE'),
					'status'	=>	'1',
					'plan_id'		=>	array('in',implode(',',array_column($plan, 'id'))),
			);
		}
		/*分页设置*/
		C('VAR_PAGE','pageNum');
		$count = $db->where($map)->count();// 查询满足要求的总记录数
		$num = 25;
		$p = new \Item\Service\Page($count,$num);
		$currentPage = !empty($_REQUEST[C('VAR_PAGE')])?$_REQUEST[C('VAR_PAGE')]:1;
		$firstRow = ($currentPage - 1) * $num;
		$listRows = $currentPage * $num;		
		$list = $db->where($map)->order("createtime DESC")->limit($firstRow . ',' . $p->listRows)->select();
		$this->assign ( 'totalCount', $count );
		$this->assign ( 'numPerPage', $p->listRows);
		$this->assign ( 'currentPage', !empty($_REQUEST[C('VAR_PAGE')])?$_REQUEST[C('VAR_PAGE')]:1);		
		$this->assign('data',$list)
			->assign('map',$map)
			->display();
	}
	/**
	 * 预定单管理
	 */
	function bookTicket(){
		if(IS_POST){
			$sn = I('post.sn');
			$map = array(
				'product_id'=>\Libs\Util\Encrypt::authcode($_SESSION['lub_proId'], 'DECODE'),
				'order_sn' =>$sn,
			);		
		}else{
			$map = array(
				'product_id'=>\Libs\Util\Encrypt::authcode($_SESSION['lub_proId'], 'DECODE'),
				'status'=>5,
				'createtime'=>array('GT', strtotime(date("Ymd",time()))),//过滤已过期的订单
			);
		}
		$list = Operate::do_read('Order',1,$map);
		$this->assign('data',$list)
			->display();
	}
	/**
	 *订单详情
	 */
	function orderinfo(){
		if(IS_POST){
			$sn = I('sn');
			if(empty($sn)){
				$this->erun('参数错误!');
			}
			//提交备注
			$remark = I('win_rem');
			if(M('OrderData')->where(array('order_sn'=>$sn))->setField('win_rem',$remark)){
				$this->srun("备注成功");
			}else{
				$this->erun("备注失败");
			}
		}else{
			$sn = I('sn');
			if(empty($sn)){
				$this->erun('参数错误!');
			}
			$info = D('Order')->where(array('order_sn'=>$sn))->relation(true)->find();
			$info['info']=unserialize($info['info']);
			//区域分类
			foreach ($info['info']['data'] as $key => $value) {
				$area[$value['areaId']]['area'] = $value['areaId'];
				$area[$value['areaId']]['num'] = $area[$value['areaId']]['num']+1;
			}
			/*
			if(I('tt') == '1'){
				 $seat = M('Seat_41_150503_1')->where(array('order_sn'=>$info['order_sn']))->select();
				 $crm[0] = array('phone'=>$info['phone'],'contact'=>$info['take']);
				 $newData = array(
					'subtotal'	=> $info['money'],
					'checkin'	=> $info['checkin'],
					'data'		=> $seat,
					'crm'		=> $crm[0],
					'pay'		=> $pay,				
					'param'		=> $info['param'],	
				);
				 dump($info);
			}*/
			//dump($info);
			$this->assign('data',$info)
				->assign('area',$area)
				->display();
		}
	}
	/*加载当前产品当前销售计划的可售区域*/
	private function available(){
		$plan = session('plan');
		if(empty($plan)){
			//强制刷新售票navtab
		}
		//可售区域 及授权票型
		$param = unserialize($plan['param']);
		//加载当前销售情况
		$this->assign('param',$param)
			 ->assign('plan',$plan);
	}
	/**
	 * 获取当前区域价格与座椅信息 景区产品根据销售计划获取价格信息
	 * @param $areaId int 当前区域ID
	 * @param $type int 读取票型类型 1、获取散客票 2、获取团队 3、散客团队 4、获取政企 9、获取所有票型
	 * @param $protype int 产品类型
	 */
	private function getPrice($type, $protype = '1', $areaId = null){
		$plan = session('plan');
		switch ($type) {
			case '1':
				$types = array('in','1,3,4');
				break;
			case '2':
				$types = array('in','2,3');
				break;
			case '3':
				$types = array('in','1,2,3');
				break;
			case '4':
				$types = array('in','1,3,4');
				break;
			case '9':
				$types = array('in','1,2,3,4');
				break;
			default:
				$types = array('in','1,3,4');
				break;
		}
		if(empty($plan)){
			//强制刷新售票navtab
		}
		//可售区域 及授权票型
		$param = unserialize($plan['param']);
		if($protype == '1'){
			$map = array('area'=>$areaId,'status'=>1,'type'=>$types,'scene'=>'1','product_id'=>$this->product['id']);
			//获取当前可售数量
			$table=ucwords($plan['seat_table']);
			$area_num = D($table)->where(array('area'=>$areaId,'status'=>'0'))->count();
			$area_nums = D($table)->where(array('area'=>$areaId,'status'=>'2'))->count();
		}else{
			$map = array('status'=>1,'type'=>$types,'scene'=>'1','product_id'=>$this->product['id']);
		}		
		//获取价格信息
		$tickets = Operate::do_read('TicketType',1,$map);
		foreach ($param['ticket'] as $v){
			foreach ($tickets as $va){
				if($v == $va['id']){
					$va['area_num'] = $area_num;
					$va['area_nums']= $area_nums;
					$price[] = $va;
				}
			}
		}
		return $price;
	}
	/**
	 * 退票管理
	 */
	function refund(){
		//获取当前产品ID
		$product_id = \Libs\Util\Encrypt::authcode($_SESSION['lub_proId'], 'DECODE');
		//获取模板ID
		$product = Operate::do_read('Product',0,array('id'=>$product_id));
		$area = Operate::do_read('Area',0,array('template_id'=>$product['template_id']),'',array('id','name'));
		if(IS_POST){
			$pinfo = I('post.');		
		}		
		$this->assign('data',$data)
			->assign('area',$area)
			->display();
	}
	/** 
	 *  渠道取消订单申请列表
	 */	
	function channel_refund(){
		$start_time = I('start_time');
	    $end_time = I('end_time') ? I('end_time') : date('Y-m-d',time());
	    //传递条件
	    $this->assign('starttime',$start_time);
        $this->assign('endtime',$end_time);
        if (!empty($start_time) && !empty($end_time)) {
            $start_time = strtotime($start_time);
            $end_time = strtotime($end_time) + 86399;
            $where['createtime'] = array(array('GT', $start_time), array('LT', $end_time), 'AND');
        }else{
        	//默认显示当天的订单
        	$start_time = strtotime(date("Ymd"));
            $end_time = $start_time + 86399;
        	$where['createtime'] = array(array('EGT', $start_time), array('ELT', $end_time), 'AND');
        }
		$user_id = \Libs\Util\Encrypt::authcode($_SESSION['lub_imuid'], 'DECODE');  //当前登录用户id
		$c_data  = Operate::do_read('User',0,array("id"=>$user_id));
		//TODO 限定显示有效数据
		if($c_data["cid"] != ""){
			$where["crm_id"] = $c_data["cid"];
			$this->assign("crm_id",$where["crm_id"]);
		}
		$where['launch'] = '2';
		$count = M("TicketRefund")->where($where)->count();// 查询满足要求的总记录数
		$p = new \Item\Service\Page($count,20);
		$currentPage = !empty($_REQUEST["pageNum"])?$_REQUEST["pageNum"]:1;
		$firstRow = ($currentPage - 1) * 20;
		$list = M("TicketRefund")->where($where)->order("id DESC")->limit($firstRow . ',' . $p->listRows)->select();	
		$this->assign("list",$list);
		
		/*分页设置赋值*/
		$this->assign ( 'totalCount', $count );
		$this->assign ( 'numPerPage', $p->listRows);
		$this->assign ( 'currentPage', $currentPage);
		$this->display();
	}
	/**
	 * 窗口退票
	 */
	function window_refund(){
		if(IS_POST){
			$pinfo = I('post.');
			if(empty($pinfo['sn'])){$this->erun("查询条件初始化失败!");}
			$info = Operate::do_read('Order',0,array('order_sn'=>$pinfo['sn']),'','',true);
			//取消中的订单不允许窗口退票
			$no_refund =  array('0','2','3','7','11');
			if(in_array($info['status'],$no_refund)){
				$this->erun("该订单状态,不允许此项操作...");
			}else{
				$info['info'] = unserialize($info['info']);
				if($info['info'] == false){
					$this->assign("error","未找到相应数据!");
				}else{
					$this->assign('data',$info)
						->assign('seat',$info['info']['data'])
						->assign('pinfo',$pinfo)
						->assign('view','1');
				}
				$this->display();
			}
		}
	}
	/**
	 * 退票
	 */
	function refunds(){
		$ginfo = I('get.');
		if(empty($ginfo)){$this->erun("参数错误!");}
		if($ginfo['order'] == '1'){
			//订单内所有门票全退
			if(Refund::refund($ginfo) != false){
				$this->srun('退票成功!',$this->navTabId);
			}else{
				$this->erun('退票失败!');
			}
		}else{
			//退单个座位
			if(Refund::refund($ginfo,2,$ginfo['area'],$ginfo['seatid']) != false){
				$this->srun('退票成功!',$this->navTabId);
			}else{
				$this->erun('退票失败!');
			}		
		}
	}
	/**
	 * 同意【取消订单】申请
	 */	
	function agree(){
		$ginfo = I("post.");
		if(empty($ginfo['sn'])){
			$this->erun("参数有误!");
		}
		if(Refund::refund($ginfo,1,'','',$ginfo['poundage'])){
			$this->srun('同意退款成功!',$this->navTabId);
		}else{
			$this->erun("退票失败!");
		}
	}
	/**
	 * 订单详情
	 */
	function detail(){
		$id   = I("get.id");          //取消订单id
		$map  = array("id"=>$id);
		$data = Operate::do_read('TicketRefund',0,$map);
		$this->assign("data",$data);
		$this->display();
	}
	/**
	 * 驳回【取消订单】申请
	 */
	function against(){
		if(IS_POST){
			$ginfo = I("post.");
			$data = array(
				"id" => $ginfo["id"],
				"against_reason" => $ginfo["against_reason"],
				"status" => 2,
			);
			//改变订单状态
			$order_up = M('Order')->where(array('order_sn'=>$ginfo['sn']))->setField('status',1);
			$up = M('TicketRefund')->save($data);
			if($up && $order_up){
				$this->srun('退款申请驳回成功!',$this->navTabId);
			}else{
				$this->erun("退款申请驳回失败!");
			}
		}
	}
	/**
	 * @印象大红袍
	 * 核减
	 */
	function subtract(){
		if(IS_POST){
			$pinfo = I('post.');
			$number = 0;
			foreach ($pinfo['area'] as $k=>$v){
				$area[$v]=array(
					'area'=>$v,
					'num'=>$pinfo['seat_num'][$k],
				);
				$number = $number + $pinfo['seat_num'][$k];
			}
			//开始核减
			$subNum =  (int)$pinfo['nums'];
			if((int)$number > $subNum ){
				//超出最大核减数 
				$this->erun("超出核减总数!");
			}
			//得到订单
			$info = Operate::do_read('Order',0,array('order_sn'=>$pinfo['sn']),'','',true);
			//查看核减标示
			if(!empty($info['subtract'])){
				$this->erun("该订单已完成此项操作!");
			}
			//获取所属计划
			$plan = F('Plan_'.$info['plan_id']);
			if(empty($plan)){
				$this->erun("场次已停止，不能进行此项操作!");
			}else{
				//按区域核减
				foreach ($area as $ka=>$ve){
					$map = array('order_sn'=>$pinfo['sn'],'area'=>$ve['area']);
					$table=ucwords($plan['seat_table']);
					$seat =D($table)->where($map)->limit($ve['num'])->select();
					//按座位核减 
					foreach ($seat as $k=>$v){
						$status[$k] = Refund::refund($pinfo,2,$ve['area'],$v['seat'],'','1');
						if($status[$k] == false){
							$this->erun("核减失败!");
						}
					}
				}
				$this->srun("核减成功!",$this->navTabId);
			}
			
		}else{
			$ginfo  =  I('get.');
			if(empty($ginfo)){$this->erun("参数错误!");}
			
			$oinfo = Operate::do_read('Order',0,array('order_sn'=>$ginfo['sn'],'status'=>'1','type'=>array('in','2,4,7')),'','',true);
			if(empty($oinfo)){$this->erun("未找到订单或订单不能满足核减条件!");}
			//判断订单类型
			if($oinfo['status'] == '6'){
				//政府订单
				$subNum = $oinfo['number']-1;
			}else{
				//渠道订单
				//$subNum = $oinfo['number']*self::$Cache['Config']['subtract'];//最大可核减数
				$subNum = $oinfo['number']-1;//最大可核减数
				$subNum = (int)$subNum;
				if($subNum < 1 || !empty($oinfo['subtract'])){
					$this->erun("订单未能满足核减要求!",'','','',U('Item/Work/orderticket'));
				}
			}
			$seat = unserialize($oinfo['info']);
			foreach ($seat['data'] as $k=>$v){				
				$area[$v['areaId']][$k] = $v;
				$area[$v['areaId']]['area']	=	$v['areaId'];
				$area[$v['areaId']]['num'] = count($area[$v['areaId']])-2;		
			}
			$this->assign('num',$subNum)
				->assign('sn',$ginfo['sn'])
				->assign('area',$area);
			$this->display();
		}
	}
	/*
	* 整场退票
	*/
	function refund_entire(){
		if(IS_POST){
			$ginfo = I('post.');
			$plan_name = planShow($ginfo['plan'],1);
			echo "读取".$plan_name."<br />";
			$order = D('Order')->where(array('plan_id'=>$ginfo['plan'],'status'=>array('in','1,7,9')))->select();
			if(empty($order)){
				echo "订单列表读取失败....<br />";
			}else{
				echo "订单列表读取成功....开始退票...<br />";
			}
			//通过订单号逐个订单退票
			foreach ($order as $key => $value) {
				$info = array('sn'=>$value['order_sn']);
				$status = Refund::refund($info,1,'','','','','',2);
				if($status){
					//TODO  发送短信
					$msg = array('phone'=>$value['phone'],'title'=>planShows($value['plan_id']),'num'=>$value['number']);
					$sms = Sms::order_msg($msg,'4');
					if($sms == '01'){
						echo "订单".$value['order_sn']."短信发送成功....<br />";
					}else{
						echo "订单".$value['order_sn']."短信发送失败,请采用另一种方式通知观演人...<br />";
					}
					echo "订单".$value['order_sn']."取消成功....<br />";
				}else{
					//未能成功退票的订单
					$error_order[] = $value;
					echo "订单".$value['order_sn']."取消失败....<br />";
				}
			}
			if(empty($error_order)){
				echo "开始停用".$plan_name."<br />";
				$plans = M('Plan')->where(array('id'=>$ginfo['plan']))->setField('status',0);
				if($plans){
					echo $plan_name."取消完成。";
				}else{
					echo $plan_name."取消失败。请手动停用该场次...";
				}
			}else{
				echo planShow($ginfo['plan'],1)."存在未取消订单，请再次执行此操作。";
			}
			
		}else{
			//只能退当天的场次
			$today = strtotime(date('Y-m-d'));
			$todaya = $today."-1";
			$plan = M('Plan')->where(array('plantime'=>$today,'status'=>'2'))->select();
			$this->assign('plan',$plan)
				->assign('today',$todaya)
				->display();
		}
	}
	//座位号反查订单 二维码反查订单
	function check_oreder(){
		$pinfo = I('post.');
		if($pinfo['type'] == '1'){
			//座位号查订单
			$map = array(
				'seat' => $pinfo['sn'],
			);
			$plan_info = F('Plan_'.$pinfo['plan']);
			if(empty($plan_info)){
				$plan_info = M('Plan')->where(array('id'=>$pinfo['plan']))->find();
			}
			$info = M(ucwords($plan_info['seat_table']))->where($map)->find();
		}
		if($pinfo['type'] == '2'){
			//二维码查订单
			$info = \Libs\Service\Checkin::prison($pinfo['sn']);
		}
		$data = D('Order')->where(array('order_sn'=>$info['order_sn']))->relation(true)->find();
		if(!empty($data)){
			$data['info']=unserialize($data['info']);
			//区域分类
			foreach ($data['info']['data'] as $key => $value) {
				$area[$value['areaId']]['area'] = $value['areaId'];
				$area[$value['areaId']]['num'] = $area[$value['areaId']]['num']+1;
			}
		}else{
			$data = "4";
		}
		//读取销售计划 过期的两天 和当前未过期的全部
		$plantime = strtotime(" -2 day ",strtotime(date('Y-m-d')));
		$plan = M('Plan')->where(array('plantime'=>array('egt',$plantime)))->order('plantime ASC')->select();
		$this->assign('data',$data)
			->assign('plan',$plan)
			->assign('area',$area)
			->assign('pinfo',$pinfo)
			->display();
	}
	//查看座位详情
	function seat_info(){
		$info = I('get.');
		$plan = F('Plan_'.$info['plan_id']);
		$table = $plan['seat_table'];
		$seat = M(ucwords($plan['seat_table']))->where(array('seat'=>$info['seat']))->find();
		$this->assign('data',$seat)
			->assign('sale',unserialize($seat['sale']))
			->display();
	}
	/*窗口获取渠道商*/
	function channel(){
		if(IS_POST){
			if($_POST["name"] != ""){
				$map["name"] = array('like','%'.$_POST["name"].'%');
				$map['product_id'] = \Libs\Util\Encrypt::authcode($_SESSION['lub_proId'], 'DECODE');
				$this->assign("name",$_POST["name"]);
			}	
		}
		C('VAR_PAGE','pageNum');
		$db = M('Crm');
		$count = $db->where($map)->count();// 查询满足要求的总记录数
		$num = 9;
		$p = new \Item\Service\Page($count,$num);
		$currentPage = !empty($_REQUEST[C('VAR_PAGE')])?$_REQUEST[C('VAR_PAGE')]:1;
		$firstRow = ($currentPage - 1) * $num;
		$listRows = $currentPage * $num;
		$data = $db->where($map)->order("id ASC")->limit($firstRow . ',' . $p->listRows)->select();
		$this->assign ( 'totalCount', $count);
		$this->assign ( 'numPerPage', $p->listRows);
		$this->assign ( 'currentPage', !empty($_REQUEST[C('VAR_PAGE')])?$_REQUEST[C('VAR_PAGE')]:1);
		$this->assign("list",$data)
			->display();

	}
	/*窗口获取导游*/
	function guide(){
		if(IS_POST){
			if($_POST["name"] != ""){
				$map["nickname"] = array('like','%'.$_POST["name"].'%');
				$this->assign("name",$_POST["name"]);
			}	
		}
		if(I('type') == '1'){
			//订单查询中查询下单人
			$map['is_scene'] = array('in','2,3');
		}else{
			$map['groupid'] = '2';
		}
		C('VAR_PAGE','pageNum');
		$db = M('User');
		$count = $db->where($map)->count();// 查询满足要求的总记录数
		$num = 10;
		$p = new \Item\Service\Page($count,$num);
		$currentPage = !empty($_REQUEST[C('VAR_PAGE')])?$_REQUEST[C('VAR_PAGE')]:1;
		$firstRow = ($currentPage - 1) * $num;
		$listRows = $currentPage * $num;
		$data = $db->where($map)->order("id ASC")->limit($firstRow . ',' . $p->listRows)->select();
		$this->assign ( 'totalCount', $count);
		$this->assign ( 'numPerPage', $p->listRows);
		$this->assign ( 'currentPage', !empty($_REQUEST[C('VAR_PAGE')])?$_REQUEST[C('VAR_PAGE')]:1);
		$this->assign('type',I('type'));
		$this->assign("list",$data)
			->display();
	}
	//超量申请手动排座
	function surplus_seat(){

	}
	//补差价
	function difference()
	{
		if(IS_POST){

		}else{
			$this->display();
		}
	}
	//容灾解决
	function disaster(){
		if(IS_POST){
			$info = I('post.');
			foreach ($info['num'] as $key => $value) {
				if($value != 0){
					$data[$key]['name'] = $info['name'][$key];
					$data[$key]['price']= $info['price'][$key];
					$data[$key]['num']  = $value;
					$data[$key]['money']=$info['price'][$key]*$info['num'][$key];
					$money += $data[$key]['money'];
					$name = $name.$info['name'][$key].$value."张";
				}
				
			}
			if(empty($info['remark'])){
				$dinfo = "6月28日票款，".$name."共计".$money."元";
			}else{
				$dinfo = $info['remark'].",6月28日票款，".$name."共计".$money."元";
			}
			if(!empty($money) && !empty($info['orgLookup_id'])){
				//获取扣费条件
				$model = new \Common\Model\Model();
				$model->startTrans();
				$cid = money_map($info['orgLookup_id']);
				//先消费后记录
				$c_pay = $model->table(C('DB_PREFIX').'crm')->where(array('id'=>$cid))->setDec('cash',$money);
				$data = array(
					'cash'		=>	$money,
					'user_id'	=>	\Libs\Util\Encrypt::authcode($_SESSION['lub_imuid'], 'DECODE'),
					'crm_id'	=>	$cid,
					'createtime'=>	time(),
					'type'		=>	'2',
					'order_sn'	=>	'20150628',
					'balance'	=>  balance($cid),
					'remark'	=>  $dinfo,
				);
				$c_pay2 = $model->table(C('DB_PREFIX').'crm_recharge')->add($data);
				if($c_pay == false || $c_pay2 == false){echo "string";
					$model->rollback();//事务回滚
					$this->erun("未找到操作条件!");
				}else{
					$model->commit();//提交事务
					$this->srun("扣费成功!");
				}
			}else{
				$this->erun("未找到操作条件!");
			}
			
		}else{
			$this->display();
		}
	}
}